{% extends "base.html" %}
{% load static %}

<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

{% block content %}
<div class="container mt-5">
     <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-6 flex items-center justify-between mb-6">
    <!-- Welcome Message -->
     <div>
     <h2 class="text-2xl font-bold text-slate-900 dark:text-white">
        Welcome back
        {% if user_role == "INDIVIDUAL_PROVIDER" %}
            Physician
        {% elif user_role == "ORGANIZATION" %}
            Organization
        {% else %}
            {{ user.username }}
        {% endif %}
    </h2>
    <p class="mt-1 text-slate-600 dark:text-slate-400">Manage your shop and view your orders here.</p>
</div>
    <div class="flex items-center space-x-3">
            <button type="button" id="openCategoriesBtn"
            class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">View All Categories</button>
            <a href="{% url 'giftshops:create_product' %}"
            class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-emerald-700 transition">
            + Add New Product</a>
          </div>
</div>
    <!-- Category Section -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h2 class="text-2xl font-bold text-slate-900 mb-6">Manage your products by categories</h2>

        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6">
            {% for category in categories %}
            <a href="{% url 'giftshops:category_products' category.id %}"
            class="group block rounded-xl overflow-hidden shadow-md hover:shadow-xl transition-shadow bg-white">
            {% if category.category_photo %}
            <img src="{{ category.category_photo.url }}" alt="{{ category.name }}"
            class="h-32 w-full object-cover group-hover:scale-105 transform transition duration-300">
            {% else %}
            <div class="h-32 flex items-center justify-center bg-slate-100 text-slate-500">
                No Image
            </div>
            {% endif %}
            <div class="p-3 text-center">
                <h3 class="text-sm font-medium text-slate-800 group-hover:text-teal-600">
                    {{ category.name }}
                </h3>
            </div>
        </a>
        {% endfor %}
    </div>
</section>
<!-- All Products Section -->
 <div class="mt-10">
    <div class="flex items-center justify-between mb-6">
        <!-- Left: Heading -->
         <h3 class="text-2xl font-semibold">üõç Your Products</h3>
        </div>
        {% if products %}
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {% for product in products %}
            <div class="group bg-white dark:bg-slate-800 rounded-xl shadow-sm hover:shadow-lg border border-slate-200 dark:border-slate-700 transition-all duration-300 overflow-hidden h-full flex flex-col">
                <!-- Image Container -->
                <div class="relative h-48 w-full bg-slate-100 dark:bg-slate-700 overflow-hidden">
                    {% if product.image %}
                        <img src="{{ product.image.url }}" alt="{{ product.name }}"
                             class="h-full w-full object-cover group-hover:scale-105 transition-transform duration-300">
                    {% else %}
                        <div class="h-full w-full flex items-center justify-center bg-slate-200 dark:bg-slate-600">
                            <svg class="h-12 w-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                    {% endif %}

                    <!-- Featured Badge -->
                    {% if product.is_featured %}
                    <div class="absolute top-3 left-3">
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-yellow-500 text-white shadow-sm">
                            ‚≠ê Featured
                        </span>
                    </div>
                    {% endif %}

                    <!-- Stock Status Badge -->
                    {% if product.is_out_of_stock %}
                    <div class="absolute top-3 right-3">
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-red-500 text-white shadow-sm">
                            üö´ Out of Stock
                        </span>
                    </div>
                    {% elif product.is_almost_out_of_stock %}
                    <div class="absolute top-3 right-3">
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-orange-500 text-white shadow-sm">
                            ‚ö†Ô∏è Almost Out
                        </span>
                    </div>
                    {% endif %}
                </div>

                <!-- Content Container -->
                <div class="p-5 flex flex-col flex-grow">
                    <!-- Product Name -->
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-3 line-clamp-2 text-center">
                        {{ product.name }}
                    </h3>

                    <!-- Category Info -->
                    <div class="flex flex-wrap items-center gap-2 mb-4">
                        <!-- Category Badge -->
                        {% if product.category %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-teal-100 text-teal-800 dark:bg-teal-900 dark:text-teal-200">
                                {{ product.category.name }}
                            </span>
                        {% endif %}
                    </div>

                    <!-- Price & Stock Info -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex flex-col">
                            <p class="text-xl font-bold text-emerald-600 dark:text-emerald-400">${{ product.price }}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">
                                {% if product.is_out_of_stock %}
                                    Out of stock
                                {% elif product.is_almost_out_of_stock %}
                                    Only {{ product.stock_quantity }} left
                                {% else %}
                                    {{ product.stock_quantity }} in stock
                                {% endif %}
                            </p>
                        </div>

                        <!-- Management Actions -->
                        <div class="flex items-center space-x-2">
                            <!-- Edit Product -->
                            <a href="{% url 'giftshops:edit_product' product.pk %}"
                               class="p-2 bg-teal-600 hover:bg-teal-700 text-white rounded-lg transition-all duration-200 transform hover:scale-105"
                               title="Edit Product">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14.304 4.844 2.852 2.852M7 7H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-4.5m2.409-9.91a2.017 2.017 0 0 1 0 2.853l-6.844 6.844L8 14l.713-3.565 6.844-6.844a2.015 2.015 0 0 1 2.852 0Z"/>
                                </svg>
                            </a>

                            <!-- Delete Product -->
                            <form method="post" action="{% url 'giftshops:delete_product' product.pk %}" class="inline-block">
                                {% csrf_token %}
                                <button type="submit"
                                        class="p-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all duration-200 transform hover:scale-105"
                                        title="Delete Product"
                                        onclick="return confirm('Are you sure you want to delete this product?')">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 7h14m-9 3v8m4-8v8M10 3h4a1 1 0 0 1 1 1v3H9V4a1 1 0 0 1 1-1ZM6 7h12v13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7Z"/>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Description -->
                    {% if product.description %}
                    <p class="text-sm text-slate-700 dark:text-slate-400 flex-grow mb-4 line-clamp-3">
                        {{ product.description|truncatewords:15 }}
                    </p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <!-- Pagination -->
     <div class="mt-6 flex justify-between items-center">
        <div>
            {% if products.has_previous %}
            <a href="?page={{ products.previous_page_number }}" class="px-3 py-1 bg-slate-200 rounded">Prev</a>
            {% endif %}
            <span class="px-3 py-1">{{ products.number }} / {{ products.paginator.num_pages }}</span>
            {% if products.has_next %}
            <a href="?page={{ products.next_page_number }}" class="px-3 py-1 bg-slate-200 rounded">Next</a>
            {% endif %}
        </div>
    </div>
    {% else %}
    <p class="text-slate-600 mt-4">You have not added any products yet.</p>
    {% endif %}
</div>


<section class="mt-10">
    <h2 class="text-2xl font-bold mb-4">üåü Featured Products</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {% for product in featured_products %}
        <div class="flex flex-col w-full max-w-sm bg-white border border-slate-200 rounded-lg shadow-sm dark:bg-slate-800 dark:border-slate-700 h-full">
            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="relative flex items-center justify-center bg-slate-100 dark:bg-slate-700 h-48 w-full overflow-hidden rounded-t-lg">
            <div class="p-4">
                <h3 class="text-xl font-semibold tracking-tight text-slate-900 dark:text-white">{{ product.name }}</h3>
                <p class="text-base font-bold text-emerald-600">‚Ç¶{{ product.price }}</p>
                <p class="mb-3 font-normal text-slate-700 dark:text-slate-400 flex-grow">{{ product.description|truncatewords:15 }}</p>
                <a href="{% url 'giftshops:product_detail' product.pk %}" class="mt-2 inline-block text-teal-600 hover:underline">See full details</a>
            </div>
        </div>
        {% empty %}
        <p>No featured products available.</p>
        {% endfor %}
    </div>

    <!-- ‚úÖ Featured Pagination -->
    <div class="mt-6 flex justify-between items-center">
      <div>
        {% if featured_products.has_previous %}
          <a href="?featured_page={{ featured_products.previous_page_number }}" class="px-3 py-1 bg-slate-200 rounded">Prev</a>
        {% endif %}

        <span class="px-3 py-1">{{ featured_products.number }} / {{ featured_products.paginator.num_pages }}</span>

        {% if featured_products.has_next %}
          <a href="?featured_page={{ featured_products.next_page_number }}" class="px-3 py-1 bg-slate-200 rounded">Next</a>
        {% endif %}
      </div>
    </div>
</section>

    <!-- Orders Section -->
<div class="mt-5">
    <h3>Orders for Your Products</h3>
    {% if orders %}
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Items</th>
                    <th>Total Amount</th>
                    <th>Status</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                    <tr>
                        <td>#{{ order.id }}</td>
                        <td>{{ order.customer.username }}</td>
                        <td>
                            <ul>
                                {% for item in order.items.all %}
                                    {% if item.product.created_by == user %}
                                        <li>{{ item.quantity }} √ó {{ item.product.name }} ‚Äî ${{ item.total_price }}</li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </td>
                        <td>${{ order.total_amount }}</td>
                        <td>{{ order.status }}</td>
                        <td>{{ order.order_date|date:"M d, Y H:i" }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No orders have been placed for your products yet.</p>
    {% endif %}
</div>

</div>

<!-- Categories Modal (place near the end of the template, still inside block content) -->
<div id="categoriesModal"
     class="fixed inset-0 hidden z-50 items-center justify-center bg-black bg-opacity-50 p-4">
  <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-6xl p-8 relative overflow-y-auto max-h-[85vh]">
    <div class="flex items-center justify-between mb-8">
      <!-- Title -->
      <h2 class="text-2xl text-slate-900 dark:text-white font-extrabold">All Categories</h2>

      <!-- Close Button -->
      <button type="button" id="closeCategoriesBtn"
              class="text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200 text-xl leading-none">
        ‚úï
      </button>
    </div>

    <!-- Render categories directly  -->
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-8">
      {% for category in all_categories %}
        <a href="{% url 'giftshops:category_products' category.id %}"
           class="group block rounded-xl overflow-hidden border border-slate-200 dark:border-slate-600 hover:shadow-xl transition-all duration-300 bg-white dark:bg-slate-700 transform hover:scale-105">
          {% if category.category_photo %}
            <img src="{{ category.category_photo.url }}" alt="{{ category.name }}"
                 class="h-32 w-full object-cover group-hover:scale-110 transition-transform duration-300">
          {% else %}
            <div class="h-32 flex items-center justify-center bg-slate-100 dark:bg-slate-600 text-slate-500 dark:text-slate-400">
              <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
            </div>
          {% endif %}
          <div class="p-4 text-center">
            <h3 class="text-sm font-medium text-slate-800 dark:text-slate-200 group-hover:text-teal-600 line-clamp-2">
              {{ category.name }}
            </h3>
          </div>
        </a>
      {% empty %}
        <p class="col-span-full text-slate-500 dark:text-slate-400 text-center py-8">No categories available.</p>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  (function () {
    const modal = document.getElementById('categoriesModal');
    const openBtn = document.getElementById('openCategoriesBtn');
    const closeBtn = document.getElementById('closeCategoriesBtn');

    function openModal() {
      modal.classList.remove('hidden');
      modal.classList.add('flex');          // make it flex-centered
      document.body.classList.add('overflow-hidden'); // prevent background scroll
    }

    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.classList.remove('overflow-hidden');
    }

    if (openBtn) openBtn.addEventListener('click', openModal);
    if (closeBtn) closeBtn.addEventListener('click', closeModal);

    // click backdrop to close
    modal.addEventListener('click', function (e) {
      if (e.target === modal) closeModal();
    });

    // ESC to close
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });
  })();
</script>



{% endblock %}
